name: Build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # -------------------------
      # Checkout code
      # -------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------
      # Install detect-secrets
      # -------------------------
      - name: Install detect-secrets
        run: |
          python3 -m pip install --upgrade pip
          pip install detect-secrets

      # -------------------------
      # ðŸ” SECRET SCAN (FAIL CI/CD IF FOUND)
      # -------------------------
      - name: Run secret scan
        run: |
          detect-secrets scan . > scan-result.json

          python3 - << 'EOF'
          import json, sys

          with open("scan-result.json") as f:
              data = json.load(f)

          results = data.get("results", {})

          if results:
              print("\nâŒ Secrets found in repository!\n")
              for file, issues in results.items():
                  print(f"ðŸ“„ File: {file}")
                  for item in issues:
                      print(f"   âž¤ Line: {item.get('line_number')}")
                      print(f"   âž¤ Type: {item.get('type')}")
                      print(f"   âž¤ Hash: {item.get('hashed_secret')}\n")
              sys.exit(1)
          else:
              print("âœ… No secrets found.")
          EOF

      # -------------------------
      # Your normal build step
      # -------------------------
      - name: Continue build
        run: |
          echo "âœ… No secrets found. Build continues..."
