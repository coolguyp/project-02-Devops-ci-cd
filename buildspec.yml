version: 0.2

env:
  variables:
    CLUSTER_NAME: my-eks-cluster
    SONAR_HOST_URL: http://<SONARQUBE-ELB-DNS>:9000   ### ADD THIS
    SONAR_TOKEN: squ_8797ba9e7009800ad5ffd6c16adbd3df3932379d

phases:
  install:
    runtime-versions:
      java: corretto17
    commands:
      - echo "Installing SonarScanner"
      - curl -sSLo sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
      - unzip sonar-scanner.zip
      - export PATH=$PATH:$(pwd)/sonar-scanner-5.0.1.3006-linux/bin
      - sonar-scanner --version   ### VERIFY INSTALL

  pre_build:
    commands:
      - echo "Logging in to Amazon ECR"
      - aws --version
      - docker --version
      - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com

      - BACKEND_IMAGE=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/todo-backend:latest
      - FRONTEND_IMAGE=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/todo-frontend:latest
      - NGINX_IMAGE=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/todo-nginx:latest

  build:
    commands:
      ### ---------------- SONARQUBE BACKEND SCAN ----------------
      - echo "Running SonarQube scan for backend"
      - cd backend
      - sonar-scanner \
          -Dsonar.projectKey=todo-backend \
          -Dsonar.projectName=todo-backend \
          -Dsonar.sources=. \
          -Dsonar.host.url=$SONAR_HOST_URL \
          -Dsonar.login=$SONAR_TOKEN
      - cd ..

      ### ---------------- SONARQUBE FRONTEND SCAN ----------------
      - echo "Running SonarQube scan for frontend"
      - cd frontend
      - sonar-scanner \
          -Dsonar.projectKey=todo-frontend \
          -Dsonar.projectName=todo-frontend \
          -Dsonar.sources=src \
          -Dsonar.host.url=$SONAR_HOST_URL \
          -Dsonar.login=$SONAR_TOKEN
      - cd ..

      ### ---------------- DOCKER BUILD ----------------
      - echo "Building Docker images"
      - docker build -t todo-backend ./backend
      - docker tag todo-backend:latest $BACKEND_IMAGE

      - docker build -t todo-frontend ./frontend
      - docker tag todo-frontend:latest $FRONTEND_IMAGE

      - docker build -t todo-nginx ./nginx
      - docker tag todo-nginx:latest $NGINX_IMAGE

  post_build:
    commands:
      - echo "Pushing Docker images to ECR"
      - docker push $BACKEND_IMAGE
      - docker push $FRONTEND_IMAGE
      - docker push $NGINX_IMAGE

      - echo "Deploying to EKS"
      - aws eks update-kubeconfig --region $AWS_REGION --name $CLUSTER_NAME
      - kubectl apply -f k8/
      - kubectl rollout restart deployment todo-backend
      - kubectl rollout restart deployment todo-frontend
      - kubectl rollout restart deployment todo-nginx
